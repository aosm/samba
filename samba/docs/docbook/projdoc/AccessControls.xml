<chapter id="AccessControls">
<chapterinfo>
	&author.jht;
	&author.jeremy;
	<author>&person.jelmer;<contrib>drawing</contrib></author>
	<pubdate>May 10, 2003</pubdate>
</chapterinfo>
<title>File, Directory and Share Access Controls</title>

<indexterm><primary>ACLs</primary></indexterm>
<para>
Advanced MS Windows users are frequently perplexed when file, directory and share manipulation of
resources shared via Samba do not behave in the manner they might expect. MS Windows network
administrators are often confused regarding network access controls and how to
provide users with the access they need while protecting resources from unauthorised access.
</para>

<para>
Many UNIX administrators are unfamiliar with the MS Windows environment and in particular
have difficulty in visualizing what the MS Windows user wishes to achieve in attempts to set file
and directory access permissions. 
</para>

<para>
The problem lies in the differences in how file and directory permissions and controls work
between the two environments. This difference is one that Samba can not completely hide, even
though it does try to bridge the chasm to a degree.
</para>

<indexterm><primary>Extended Attributes</primary></indexterm>
<para>
POSIX Access Control List technology has been available (along with Extended Attributes)
for UNIX for many years, yet there is little evidence today of any significant use. This
explains to some extent the slow adoption of ACLs into commercial Linux products. MS Windows
administrators are astounded at this given that ACLs were a foundational capability of the now
decade old MS Windows NT operating system.
</para>

<para>
The purpose of this chapter is to present each of the points of control that are possible with
Samba-3 in the hope that this will help the network administrator to find the optimum method
for delivering the best environment for MS Windows desktop users.
</para>

<para>
This is an opportune point to mention that Samba was created to provide a means of interoperability
and interchange of data between differing operating environments. Samba has no intent change
UNIX/Linux into a platform like MS Windows. Instead the purpose was and is to provide a sufficient
level of exchange of data between the two environments.  What is available today extends well
beyond early plans and expectations, yet the gap continues to shrink.
</para>

<sect1>
<title>Features and Benefits</title>

	<para>
	Samba offers a lot of flexibility in file system access management. These are the key access control
	facilities present in Samba today:
	</para>

	<itemizedlist>
	<title>Samba Access Control Facilities</title>
		<listitem><para>
		<emphasis>UNIX File and Directory Permissions</emphasis>
		</para>

			<para>
			Samba honours and implements UNIX file system access controls. Users
			who access a Samba server will do so as a particular MS Windows user.
			This information is passed to the Samba server as part of the logon or
			connection setup process. Samba uses this user identity to validate
			whether or not the user should be given access to file system resources
			(files and directories). This chapter provides an overview for those
			to whom the UNIX permissions and controls are a little strange or unknown.
			</para>
		</listitem>

		<listitem><para>
		<emphasis>Samba Share Definitions</emphasis>
		</para>

			<para>
			In configuring share settings and controls in the &smb.conf; file
			the network administrator can exercise over-rides to native file
			system permissions and behaviours. This can be handy and convenient
			to affect behaviour that is more like what MS Windows NT users expect
			but it is seldom the <emphasis>best</emphasis> way to achieve this.
			The basic options and techniques are described herein.
			</para>
		</listitem>

		<listitem><para>
		<emphasis>Samba Share ACLs</emphasis>
		</para>

			<para>
			Just like it is possible in MS Windows NT to set ACLs on shares
			themselves, so it is possible to do this in Samba.
			Very few people make use of this facility, yet it remains on of the
			easiest ways to affect access controls (restrictions) and can often
			do so with minimum invasiveness compared with other methods.
			</para>
		</listitem>

		<listitem><para>
		<emphasis>MS Windows ACLs through UNIX POSIX ACLs</emphasis>
		</para>

			<para>
			The use of POSIX ACLs on UNIX/Linux is possible ONLY if the underlying
			operating system supports them. If not, then this option will not be
			available to you. Current UNIX technology platforms have native support
			for POSIX ACLs. There are patches for the Linux kernel that provide
			this also. Sadly, few Linux platforms ship today with native ACLs and
			Extended Attributes enabled. This chapter has pertinent information
			for users of platforms that support them.
			</para>
		</listitem>
	</itemizedlist>

</sect1>

<sect1>
<title>File System Access Controls</title>

<para>
Perhaps the most important recognition to be made is the simple fact that MS Windows NT4 / 200x / XP
implement a totally divergent file system technology from what is provided in the UNIX operating system
environment. Firstly we should consider what the most significant differences are, then we shall look
at how Samba helps to bridge the differences.
</para>

<indexterm><primary>NTFS</primary></indexterm>
<indexterm><primary>File System</primary></indexterm>
	<sect2>
	<title>MS Windows NTFS Comparison with UNIX File Systems</title>

	<para>
	Samba operates on top of the UNIX file system. This means it is subject to UNIX file system conventions
	and permissions. It also means that if the MS Windows networking environment requires file system
	behaviour that differs from unix file system behaviour then somehow Samba is responsible for emulating
	that in a transparent and consistent manner.
	</para>

	<para>
	It is good news that Samba does this to a very large extent and on top of that provides a high degree
	of optional configuration to over-ride the default behaviour. We will look at some of these over-rides,
	but for the greater part we will stay within the bounds of default behaviour. Those wishing to explore
	to depths of control ability should review the &smb.conf; man page.
	</para>

	<variablelist>
		<title>File System Feature Comparison</title>
		<varlistentry>
			<term>Name Space</term>
			<listitem>
		<para>
		MS Windows NT4 / 200x/ XP files names may be up to 254 characters long, UNIX file names
		may be 1023 characters long. In MS Windows file extensions indicate particular file types,
		in UNIX this is not so rigorously observed as all names are considered arbitrary. 
		</para>
		<para>
		What MS Windows calls a Folder, UNIX calls a directory.
		</para>
			</listitem>
		</varlistentry>

		<varlistentry>
			<term>Case Sensitivity</term>
			<listitem>
		<para>
		<indexterm><primary>8.3</primary><secondary>file names</secondary></indexterm>
		MS Windows file names are generally upper case if made up of 8.3 (ie: 8 character file name
		and 3 character extension. If longer than 8.3 file names are Case Preserving, and Case
		Insensitive.
		</para>
		<para>
		UNIX file and directory names are case sensitive and case preserving. Samba implements the
		MS Windows file name behaviour, but it does so as a user application. The UNIX file system
		provides no mechanism to perform case insensitive file name lookups. MS Windows does this
		by default. This means that Samba has to carry the processing overhead to provide features
		that are NOT native to the UNIX operating system environment.
		</para>
		<para>
		Consider the following, all are unique UNIX names but one single MS Windows file name:
		<computeroutput>
				MYFILE.TXT
				MyFile.txt
				myfile.txt
		</computeroutput>
		So clearly, In an MS Windows file name space these three files CAN NOT co-exist! But in UNIX 
		they can. So what should Samba do if all three are present? Answer, the one that is lexically
		first will be accessible to MS Windows users, the others are invisible and unaccessible - any
		other solution would be suicidal.
		</para>
			</listitem>
		</varlistentry>

		<varlistentry>
			<term>Directory Separators</term>
			<listitem>
		<para>
		MS Windows and DOS uses the back-slash '\' as a directory delimiter, UNIX uses the forward-slash '/'
		as it's directory delimiter. This is transparently handled by Samba.
		</para>
			</listitem>
		</varlistentry>

		<varlistentry>
			<term>Drive Identification</term>
			<listitem>
		<para>
		MS Windows products support a notion of drive letters, like <command>C:</command> to represent
		disk partitions. UNIX has NO concept if separate identifiers for file partitions since each
		such file system is <filename>mounted</filename> to become part of the over-all directory tree.
		The UNIX directory tree begins at '/', just like the root of a DOS drive is specified like
		<command>C:\</command>.
		</para>
			</listitem>
		</varlistentry>

		<varlistentry>
			<term>File Naming Conventions</term>
			<listitem>
		<para>
		MS Windows generally never experiences file names that begin with a '.', while in UNIX these
		are commonly found in a user's home directory. Files that begin with a '.' are typically
		either start up files for various UNIX applications, or they may be files that contain
		start-up configuration data.
		</para>
			</listitem>
		</varlistentry>

		<varlistentry>
			<term>Links and Short-Cuts</term>
			<listitem>
		<para>
		<indexterm><primary>Links</primary><secondary>hard</secondary></indexterm>
		<indexterm><primary>Links</primary><secondary>soft</secondary></indexterm>
		<indexterm><primary>Short-Cuts</primary></indexterm>

		MS Windows make use of "links and Short-Cuts" that are actually special types of files that will
		redirect an attempt to execute the file to the real location of the file. UNIX knows of file and directory
		links, but they are entirely different from what MS Windows users are used to.
		</para>
		<para>
		Symbolic links are files in UNIX that contain the actual location of the data (file OR directory). An
		operation (like read or write) will operate directly on the file referenced. Symbolic links are also
		referred to as 'soft links'. A hard link is something that MS Windows is NOT familiar with. It allows
		one physical file to be known simultaneously by more than one file name.
		</para>
			</listitem>
		</varlistentry>
	</variablelist>

	<para>
	There are many other subtle differences that may cause the MS Windows administrator some temporary discomfort
	in the process of becoming familiar with UNIX/Linux. These are best left for a text that is dedicated to the
	purpose of UNIX/Linux training/education.
	</para>

	</sect2>

	<sect2>
	<title>Managing Directories</title>

	<para>
	There are three basic operations for managing directories, <command>create, delete, rename</command>.
	<table frame="all">
		<title>Managing directories with unix and windows</title>
		<tgroup align="center" cols="3">
		<thead>
		<row><entry>Action</entry><entry>MS Windows Command</entry><entry>UNIX Command</entry></row>
		</thead>
	
		<tbody>
			<row><entry>create</entry><entry>md folder</entry><entry>mkdir folder</entry></row>
			<row><entry>delete</entry><entry>rd folder</entry><entry>rmdir folder</entry></row>
			<row><entry>rename</entry><entry>rename oldname newname</entry><entry>mv oldname newname</entry></row>
		</tbody>
	</tgroup>
	</table>
	</para>

	</sect2>

	<sect2>
	<title>File and Directory Access Control</title>

	<para>
	The network administrator is strongly advised to read foundational training manuals and reference materials
	regarding file and directory permissions maintenance. Much can be achieved with the basic UNIX permissions
	without having to resort to more complex facilities like POSIX Access Control Lists (ACLs) or Extended
	Attributes (EAs).
	</para>

	<para>
	UNIX/Linux file and directory access permissions involves setting three (3) primary sets of data and one (1) control set.
	A UNIX file listing looks as follows:-

<screen>
&prompt;<userinput>ls -la</userinput>
total 632
drwxr-xr-x   13 maryo   gnomes      816 2003-05-12 22:56 .
drwxrwxr-x   37 maryo   gnomes     3800 2003-05-12 22:29 ..
dr-xr-xr-x    2 maryo   gnomes       48 2003-05-12 22:29 muchado02
drwxrwxrwx    2 maryo   gnomes       48 2003-05-12 22:29 muchado03
drw-rw-rw-    2 maryo   gnomes       48 2003-05-12 22:29 muchado04
d-w--w--w-    2 maryo   gnomes       48 2003-05-12 22:29 muchado05
dr--r--r--    2 maryo   gnomes       48 2003-05-12 22:29 muchado06
drwsrwsrwx    2 maryo   gnomes       48 2003-05-12 22:29 muchado08
----------    1 maryo   gnomes     1242 2003-05-12 22:31 mydata00.lst
--w--w--w-    1 maryo   gnomes     7754 2003-05-12 22:33 mydata02.lst
-r--r--r--    1 maryo   gnomes    21017 2003-05-12 22:32 mydata04.lst
-rw-rw-rw-    1 maryo   gnomes    41105 2003-05-12 22:32 mydata06.lst
&prompt;
</screen>
	</para>

	<para>
	The columns above represent (from left to right): permissions, number of hard links to file, owner, group, size (bytes), access date, access time, file name.
	</para>

	<para>
		An overview of the permissions field can be found in <link linkend="access1">the image below</link>.
	</para>

	<image scale="40"><imagedescription>Overview of unix permissions field</imagedescription><imagefile>access1</imagefile></image>

	<para>
	Any bit flag may be unset. An unset bit flag is the equivalent of 'Can NOT' and is represented as a '-' character.

	<example>
		<title>Example File</title>
		<programlisting>
		-rwxr-x---   Means: The owner (user) can read, write, execute
		                    the group can read and execute
		                    everyone else can NOT do anything with it
		</programlisting>
	</example>

	</para>

	<para>
	Additional possibilities in the [type] field are: c = character device, b = block device, p = pipe device, s = UNIX Domain Socket.
	</para>

	<para>
	The letters `rwxXst' set permissions for the user, group and others as: read (r), write (w), execute (or access for directories) (x),
	execute  only  if  the  file  is a directory or already has execute permission for some user (X), set user or group ID on execution (s),
	sticky (t).
	</para>

	<para>
	When the sticky bit is set on a directory, files in that directory may be unlinked (deleted) or renamed only by root or their owner. 
	Without the sticky  bit, anyone able to write to the directory can delete or rename files. The sticky bit is commonly found on
	directories, such as /tmp, that are world-writable.
	</para>

	<para>
	When the set user or group ID bit (s) is set on a directory, then all files created within it will be owned by the user and/or
	group whose 'set user or group' bit is set. This can be very helpful in setting up directories that for which it is desired that
	all users who are in a group should be able to write to and read from a file, particularly when it is undesirable for that file
	to be exclusively owned by a user who's primary group is not the group that all such users belong to.
	</para>

	<para>
	When a directory is set <constant>drw-r-----</constant> this means that the owner can read and create (write) files in it, but because
	the (x) execute flags are not set files can not be listed (seen) in the directory by anyone. The group can read files in the
	directory but can NOT create new files. NOTE: If files in the directory are set to be readable and writable for the group, then
	group members will be able to write to (or delete) them.
	</para>

	</sect2>

</sect1>

<sect1>
<title>Share Definition Access Controls</title>

<para>
The following parameters in the &smb.conf; file sections that define a share control or affect access controls.
Before using any of the following options please refer to the man page for &smb.conf;.
</para>

	<sect2>
	<title>User and Group Based Controls</title>

	<para>
	User and group based controls can prove very useful. In some situations it is distinctly desirable to affect all
	file system operations as if a single user is doing this, the use of the <smbconfoption><name>force user</name></smbconfoption> and 
	<smbconfoption><name>force group</name></smbconfoption> behaviour will achieve this. In other situations it may be necessary to affect a
	paranoia level of control to ensure that only particular authorised persons will be able to access a share or
	it's contents, here the use of the <smbconfoption><name>valid users</name></smbconfoption> or the <smbconfoption><name>invalid users</name></smbconfoption> may
	be most useful.
	</para>

	<para>
	As always, it is highly advisable to use the least difficult to maintain and the least ambiguous method for
	controlling access. Remember, that when you leave the scene someone else will need to provide assistance and
	if that person finds too great a mess, or if they do not understand what you have done then there is risk of
	Samba being removed and an alternative solution being adopted.
	</para>

	<table frame='all' pgwide='0'><title>User and Group Based Controls</title>
	<tgroup cols='2'>
		<colspec align="left"/>
		<colspec align="justify"/>
		<thead>
		<row>
			<entry align="center">Control Parameter</entry>
			<entry align="center">Description - Action - Notes</entry>
		</row>
		</thead>
		<tbody>
		<row>
			<entry><smbconfoption><name>admin users</name></smbconfoption></entry>
			<entry><para>
			List of users who will be granted administrative privileges on the share.
			They will do all file operations as the super-user (root).  
			Any user in this list will be able to do anything they like on the share,
			irrespective of file permissions.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force group</name></smbconfoption></entry>
			<entry><para>
			Specifies a UNIX group name that will be assigned as the default primary group
			for all users connecting to this service.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force user</name></smbconfoption></entry>
			<entry><para>
			Specifies a UNIX user name that will be assigned as the default user for all users connecting to this service.
			This is useful for sharing files. Incorrect use can cause security problems.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>guest ok</name></smbconfoption></entry>
			<entry><para>
			If this parameter is set for a service, then no password is required to connect to the service. Privileges will be 
			those of the  guest account.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>invalid users</name></smbconfoption></entry>
			<entry><para>
			List of users that should not be allowed to login to this service.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>only user</name></smbconfoption></entry>
			<entry><para>
			Controls whether connections with usernames not in the user list will be allowed.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>read list</name></smbconfoption></entry>
			<entry><para>
			List of users that are given read-only access to a service. Users in this list
			will not be given write access, no matter what the  read only  option is set to. 
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>username</name></smbconfoption></entry>
			<entry><para>
			Refer to the &smb.conf; man page for more information - this is a complex and potentially misused parameter.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>valid users</name></smbconfoption></entry>
			<entry><para>
			List of users that should be allowed to login to this service.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>write list</name></smbconfoption></entry>
			<entry><para>
			List of users that are given read-write access to a service.
			</para></entry>
		</row>
		</tbody>
	</tgroup>
	</table>

	</sect2>

	<sect2>
	<title>File and Directory Permissions Based Controls</title>

	<para>
	The following file and directory permission based controls, if misused, can result in considerable difficulty to
	diagnose the cause of mis-configuration. Use them sparingly and carefully. By gradually introducing each one by one
	undesirable side-effects may be detected. In the event of a problem, always comment all of them out and then gradually
	re-introduce them in a controlled fashion.
	</para>

	<table frame='all'><title>File and Directory Permission Based Controls</title>
		<tgroup cols='2'>
			<colspec align="left"/>
			<colspec align="justify"/>
		<thead>
		<row>
			<entry align="center">Control Parameter</entry>
			<entry align="center">Description - Action - Notes</entry>
		</row>
		</thead>
		<tbody>
		<row>
			<entry><smbconfoption><name>create mask</name></smbconfoption></entry>
			<entry><para>
			Refer to the &smb.conf; man page.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>directory mask</name></smbconfoption></entry>
			<entry><para>
			The octal modes used when converting DOS modes to UNIX modes when creating UNIX directories.
			See also: directory security mask.
			</para></entry></row>
		<row>
			<entry><smbconfoption><name>dos filemode</name></smbconfoption></entry>
			<entry><para>
			Enabling this parameter allows a user who has write access to the file to modify the permissions on it.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force create mode</name></smbconfoption></entry>
			<entry><para>
			This parameter specifies a set of UNIX mode bit permissions that will always be set on a file created by Samba.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force directory mode</name></smbconfoption></entry>
			<entry><para>
			This parameter specifies a set of UNIX mode bit permissions that will always be set on a directory created by Samba.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force directory security mode</name></smbconfoption></entry>
			<entry><para>
			Controls UNIX permission bits modified when a Windows NT client is manipulating UNIX permissions on a directory
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>force security mode</name></smbconfoption></entry>
			<entry><para>
			Controls UNIX permission bits modified when a Windows NT client manipulates UNIX permissions.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>hide unreadable</name></smbconfoption></entry>
			<entry><para>
			Prevents clients from seeing the existence of files that cannot be read.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>hide unwriteable files</name></smbconfoption></entry>
			<entry><para>
			Prevents clients from seeing the existence of files that cannot be written to. Unwriteable directories are shown as usual. 
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>nt acl support</name></smbconfoption></entry>
			<entry><para>
			This parameter controls whether smbd will attempt to map UNIX permissions into Windows NT access control lists.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>security mask</name></smbconfoption></entry>
			<entry><para>
			Controls UNIX permission bits modified when a Windows NT client is manipulating the UNIX permissions on a file.
			</para></entry>
		</row>
		</tbody>
	</tgroup>
	</table>

	</sect2>

	<sect2>
	<title>Miscellaneous Controls</title>

	<para>
	The following are documented because of the prevalence of administrators creating inadvertent barriers to file
	access by not understanding the full implications of &smb.conf; file settings.
	</para>

	<table frame='all'><title>Other Controls</title>
	<tgroup cols='2'>
		<colspec align="justify"/>
		<colspec align="justify"/>
		<thead>
		<row>
			<entry align="center">Control Parameter</entry>
			<entry align="center">Description - Action - Notes</entry>
		</row>
		</thead>
		<tbody>
		<row>
			<entry><smbconfoption><name>case sensitive</name></smbconfoption>, <smbconfoption><name>default case</name></smbconfoption>, <smbconfoption><name>short preserve case</name></smbconfoption></entry>
			<entry><para>
			This means that all file name lookup will be done in a case sensitive manner. 
			Files will be created with the precise filename Samba received from the MS Windows client.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>csc policy</name></smbconfoption></entry>
			<entry><para>
			Client Side Caching Policy - parallels MS Windows client side file caching capabilities.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>dont descend</name></smbconfoption></entry>
			<entry><para>
			Allows to specify a comma-delimited list of directories that the server should always show as empty.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>dos filetime resolution</name></smbconfoption></entry>
			<entry><para>
			This option is mainly used as a compatibility option for Visual C++ when used against Samba shares.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>dos filetimes</name></smbconfoption></entry>
			<entry><para>
			DOS and Windows allows users to change file time stamps if they can write to the file. POSIX semantics prevent this.
			This options allows DOS and Windows behaviour.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>fake oplocks</name></smbconfoption></entry>
			<entry><para>
			Oplocks are the way that SMB clients get permission from a server to locally cache file operations. If a server grants an
			oplock then the client is free to assume that it is the only one accessing the file and it will aggressively cache file data.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>hide dot files</name></smbconfoption>, <smbconfoption><name>hide files</name></smbconfoption>, <smbconfoption><name>veto files</name></smbconfoption></entry>
			<entry><para>
			Note: MS Windows Explorer allows over-ride of files marked as hidden so they will still be visible.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>read only</name></smbconfoption></entry>
			<entry><para>
			If this parameter is yes, then users of a service may not create or modify files in the service's directory.
			</para></entry>
		</row>
		<row>
			<entry><smbconfoption><name>veto files</name></smbconfoption></entry>
			<entry><para>
			List of files and directories that are neither visible nor accessible.
			</para></entry>
		</row>
		</tbody>
	</tgroup>
	</table>

	</sect2>

</sect1>

<sect1>
<title>Access Controls on Shares</title>

	<para>
	This section deals with how to configure Samba per share access control restrictions.
	By default, Samba sets no restrictions on the share itself. Restrictions on the share itself
	can be set on MS Windows NT4/200x/XP shares. This can be a very effective way to limit who can
	connect to a share. In the absence of specific restrictions the default setting is to allow
	the global user <constant>Everyone</constant> Full Control (ie: Full control, Change and Read).
	</para>

	<para>
	At this time Samba does NOT provide a tool for configuring access control setting on the Share
	itself. Samba does have the capacity to store and act on access control settings, but  the only
	way to create those settings is to use either the NT4 Server Manager or the Windows 200x MMC for
	Computer Management.
	</para>

	<para>
	Samba stores the per share access control settings in a file called <filename>share_info.tdb</filename>.
	The location of this file on your system will depend on how samba was compiled. The default location
	for Samba's tdb files is under <filename>/usr/local/samba/var</filename>. If the <filename>tdbdump</filename>
	utility has been compiled and installed on your system, then you can examine the contents of this file
	by: <userinput>tdbdump share_info.tdb</userinput>.
	</para>

	<sect2>
	<title>Share Permissions Management</title>

		<para>
		The best tool for the task is platform dependant. Choose the best tool for your environment.
		</para>

			<sect3>
			<title>Windows NT4 Workstation/Server</title>
			<para>
			The tool you need to use to manage share permissions on a Samba server is the NT Server Manager.
			Server Manager is shipped with Windows NT4 Server products but not with Windows NT4 Workstation.
			You can obtain the NT Server Manager for MS Windows NT4 Workstation from Microsoft - see details below.
			</para>

			<procedure>
			<title>Instructions</title>
			<step><para>
			Launch the <application>NT4 Server Manager</application>, click on the Samba server you want to administer, then from the menu
			select <guimenu>Computer</guimenu>, then click on the <guimenuitem>Shared Directories</guimenuitem> entry.
			</para></step>

			<step><para>
			Now click on the share that you wish to manage, then click on the <guilabel>Properties</guilabel> tab, next click on
			the <guilabel>Permissions</guilabel> tab. Now you can add or change access control settings as you wish.
			</para></step>
			</procedure>

			</sect3>

			<sect3>
			<title>Windows 200x/XP</title>

			<para>
			On <application>MS Windows NT4/200x/XP</application> system access control lists on the share itself are set using native
			tools, usually from file manager. For example, in Windows 200x: right click on the shared folder,
			then select <guimenuitem>Sharing</guimenuitem>, then click on <guilabel>Permissions</guilabel>. The default 
			Windows NT4/200x permission allows <emphasis>Everyone</emphasis> Full Control on the Share.
			</para>

			<para>
			MS Windows 200x and later all comes with a tool called the <application>Computer Management</application> snap-in for the
			Microsoft Management Console (MMC). This tool is located by clicking on <filename>Control Panel ->
			Administrative Tools -> Computer Management</filename>.
			</para>

			<procedure>
			<title>Instructions</title>
			<step><para>
				After launching the MMC with the Computer Management snap-in, click on the menu item <guimenuitem>Action</guimenuitem>,
				select <guilabel>Connect to another computer</guilabel>. If you are not logged onto a domain you will be prompted
				to enter a domain login user identifier and a password. This will authenticate you to the domain.
				If you where already logged in with administrative privilege this step is not offered.
			</para></step>

			<step><para>
			If the Samba server is not shown in the <guilabel>Select Computer</guilabel> box, then type in the name of the target
			Samba server in the field <guilabel>Name:</guilabel>. Now click on the <guibutton>[+]</guibutton> next to 
			<guilabel>System Tools</guilabel>, then on the <guibutton>[+]</guibutton> next to <guilabel>Shared Folders</guilabel> in the 
			left panel.
			</para></step>

			<step><para>
			Now in the right panel, double-click on the share you wish to set access control permissions on.
			Then click on the tab <guilabel>Share Permissions</guilabel>. It is now possible to add access control entities
			to the shared folder. Do NOT forget to set what type of access (full control, change, read) you
			wish to assign for each entry.
			</para></step>
			</procedure>

			<warning>
			<para>
			Be careful. If you take away all permissions from the <constant>Everyone</constant> user without removing this user
			then effectively no user will be able to access the share. This is a result of what is known as
			ACL precedence. ie: Everyone with <emphasis>no access</emphasis> means that MaryK who is part of the group 
			<constant>Everyone</constant> will have no access even if this user is given explicit full control access.
			</para>
			</warning>

			</sect3>
		</sect2>

</sect1>

<sect1>
<title>MS Windows Access Control Lists and UNIX Interoperability</title>

	<sect2>
		<title>Managing UNIX permissions Using NT Security Dialogs</title>

		<para>
		Windows NT clients can use their native security settings dialog box to view and modify the
		underlying UNIX permissions.
		</para>

		<para>
		Note that this ability is careful not to compromise the security of the UNIX host Samba is running on, and 
		still obeys all the file permission rules that a Samba administrator can set.
		</para>

		<para>
		Samba does not attempt to go beyond POSIX ACLs, so that the various finer-grained access control
		options provided in Windows are actually ignore.
		</para> 

		<note>
		<para>
		All access to UNIX/Linux system files via Samba is controlled by the operating system file access controls.
		When trying to figure out file access problems it is vitally important to find the identity of the Windows
		user as it is presented by Samba at the point of file access. This can best be determined from the
		Samba log files.
		</para>
		</note>
	</sect2>

	<sect2>
		<title>Viewing File Security on a Samba Share</title>

		<para>
		From an NT4/2000/XP client, single-click with the right mouse button on any file or directory in a Samba
		mounted drive letter or UNC path. When the menu pops-up, click on the <guilabel>Properties</guilabel>
		entry at the bottom of the menu. This brings up the file properties dialog box. Click on the tab
		<guilabel>Security</guilabel> and you will see three buttons, <guibutton>Permissions</guibutton>,
		<guibutton>Auditing</guibutton>, and <guibutton>Ownership</guibutton>. The <guibutton>Auditing</guibutton>
		button will cause either an error message <errorname>A requested privilege is not held by the client</errorname>
		to appear if the user is not the NT Administrator, or a dialog which is intended to allow an Administrator
		to add auditing requirements to a file if the user is logged on as the NT Administrator. This dialog is
		non-functional with a Samba share at this time, as the only useful button, the <guibutton>Add</guibutton>
		button will not currently allow a list of users to be seen.
		</para>

	</sect2>

	<sect2>
		<title>Viewing file ownership</title>

		<para>
		Clicking on the <guibutton>Ownership</guibutton> button brings up a dialog box telling you who owns
		the given file. The owner name will be of the form:
		</para>

		<para>
		<command>"SERVER\user (Long name)"</command>
		</para>

		<para>
		Where <replaceable>SERVER</replaceable> is the NetBIOS name of the Samba server, <replaceable>user</replaceable>
		is the user name of the UNIX user who owns the file, and <replaceable>(Long name)</replaceable> is the
		descriptive string identifying the user (normally found in the GECOS field of the UNIX password database).
		Click on the <guibutton>Close </guibutton> button to remove this dialog.
		</para>

		<para>
		If the parameter <smbconfoption><name>nt acl support</name></smbconfoption> is set to <constant>false</constant>
		then the file owner will be shown as the NT user <constant>"Everyone"</constant>.
		</para>

		<para>
		The <guibutton>Take Ownership</guibutton> button will not allow you to change the ownership of this file to
		yourself (clicking on it will display a dialog box complaining that the user you are currently logged onto
		the NT client cannot be found). The reason for this is that changing the ownership of a file is a privileged
		operation in UNIX, available only to the <emphasis>root</emphasis> user. As clicking on this button causes
		NT to attempt to change the ownership of a file to the current user logged into the NT client this will
		not work with Samba at this time.</para>

		<para>
		There is an NT chown command that will work with Samba and allow a user with Administrator privilege connected 
		to a Samba server as root to change the ownership of files on both a local NTFS filesystem or remote mounted NTFS 
		or Samba drive. This is available as part of the <application>Seclib</application> NT security library written
		by Jeremy Allison of the Samba-Team, available from the main Samba FTP site.</para>

	</sect2>

	<sect2>
		<title>Viewing File or Directory Permissions</title>

		<para>
		The third button is the <guibutton>Permissions</guibutton> button. Clicking on this brings up a dialog box
		that shows both the permissions and the UNIX owner of the file or directory. The owner is displayed in the form:
		</para>

		<para><command>"<replaceable>SERVER</replaceable>\
				<replaceable>user</replaceable> 
				<replaceable>(Long name)</replaceable>"</command></para>

		<para>Where <replaceable>SERVER</replaceable> is the NetBIOS name of the Samba server,
		<replaceable>user</replaceable> is the user name of the UNIX user who owns the file, and
		<replaceable>(Long name)</replaceable> is the descriptive string identifying the user (normally found in the
		GECOS field of the UNIX password database).</para>

		<para>
		If the parameter <smbconfoption><name>nt acl support</name></smbconfoption> is set to <constant>false</constant>
		then the file owner will be shown as the NT user <constant>"Everyone"</constant> and the permissions will be
		shown as NT "Full Control".
		</para>


		<para>
		The permissions field is displayed differently for files and directories, so I'll describe the way file permissions 
		are displayed first.
		</para>

		<sect3>
			<title>File Permissions</title>

			<para>The standard UNIX user/group/world triplet and 
			the corresponding "read", "write", "execute" permissions 
			triplets are mapped by Samba into a three element NT ACL 
			with the 'r', 'w', and 'x' bits mapped into the corresponding 
			NT permissions. The UNIX world permissions are mapped into 
			the global NT group <constant>Everyone</constant>, followed 
			by the list of permissions allowed for UNIX world. The UNIX 
			owner and group permissions are displayed as an NT 
			<guiicon>user</guiicon> icon and an NT <guiicon>local 
			group</guiicon> icon respectively followed by the list 
			of permissions allowed for the UNIX user and group.</para>

			<para>As many UNIX permission sets don't map into common 
			NT names such as <constant>read</constant>, <constant>
			"change"</constant> or <constant>full control</constant> then 
			usually the permissions will be prefixed by the words <constant>
			"Special Access"</constant> in the NT display list.</para>

			<para>But what happens if the file has no permissions allowed 
			for a particular UNIX user group or world component? In order 
			to  allow "no permissions" to be seen and modified then Samba 
			overloads the NT <command>"Take Ownership"</command> ACL attribute 
			(which has no meaning in UNIX) and reports a component with 
			no permissions as having the NT <command>"O"</command> bit set. 
			This was chosen of course to make it look like a zero, meaning 
			zero permissions. More details on the decision behind this will 
			be given below.</para>
		</sect3>
		
		<sect3>
			<title>Directory Permissions</title>

			<para>Directories on an NT NTFS file system have two 
			different sets of permissions. The first set of permissions 
			is the ACL set on the directory itself, this is usually displayed 
			in the first set of parentheses in the normal <constant>"RW"</constant> 
			NT style. This first set of permissions is created by Samba in 
			exactly the same way as normal file permissions are, described 
			above, and is displayed in the same way.</para>

			<para>The second set of directory permissions has no real meaning 
			in the UNIX permissions world and represents the <constant>
			inherited</constant> permissions that any file created within 
			this directory would inherit.</para>

			<para>Samba synthesises these inherited permissions for NT by 
			returning as an NT ACL the UNIX permission mode that a new file 
			created by Samba on this share would receive.</para>
		</sect3>
	</sect2>
		
	<sect2>
		<title>Modifying file or directory permissions</title>

		<para>Modifying file and directory permissions is as simple 
		as changing the displayed permissions in the dialog box, and 
		clicking the <guibutton>OK</guibutton> button. However, there are 
		limitations that a user needs to be aware of, and also interactions 
		with the standard Samba permission masks and mapping of DOS 
		attributes that need to also be taken into account.</para>

		<para>If the parameter <smbconfoption><name>nt acl support</name></smbconfoption>
		is set to <constant>false</constant> then any attempt to set 
		security permissions will fail with an <errorname>"Access Denied"
		</errorname> message.</para>

		<para>The first thing to note is that the <guibutton>"Add"</guibutton> 
		button will not return a list of users in Samba (it will give 
		an error message of <errorname>The remote procedure call failed 
		and did not execute</errorname>). This means that you can only 
		manipulate the current user/group/world permissions listed in 
		the dialog box. This actually works quite well as these are the 
		only permissions that UNIX actually has.</para>

		<para>If a permission triplet (either user, group, or world) 
		is removed from the list of permissions in the NT dialog box, 
		then when the <guibutton>OK</guibutton> button is pressed it will 
		be applied as "no permissions" on the UNIX side. If you then 
		view the permissions again the "no permissions" entry will appear 
		as the NT <command>"O"</command> flag, as described above. This 
		allows you to add permissions back to a file or directory once 
		you have removed them from a triplet component.</para>

		<para>As UNIX supports only the "r", "w" and "x" bits of 
		an NT ACL then if other NT security attributes such as "Delete 
		access" are selected then they will be ignored when applied on 
		the Samba server.</para>

		<para>When setting permissions on a directory the second 
		set of permissions (in the second set of parentheses) is 
		by default applied to all files within that directory. If this 
		is not what you want you must uncheck the <guilabel>Replace 
		permissions on existing files</guilabel> checkbox in the NT 
		dialog before clicking <guibutton>OK</guibutton>.</para>

		<para>If you wish to remove all permissions from a 
		user/group/world  component then you may either highlight the 
		component and click the <guibutton>Remove</guibutton> button, 
		or set the component to only have the special <constant>Take
		Ownership</constant> permission (displayed as <command>"O"
		</command>) highlighted.</para>
	</sect2>

	<sect2>
		<title>Interaction with the standard Samba create mask 
		parameters</title>

		<para>There are four parameters 
		to control interaction with the standard Samba create mask parameters.
		These are :

		<itemizedlist>
			<listitem><para><smbconfoption><name>security mask</name></smbconfoption></para></listitem>
			<listitem><para><smbconfoption><name>force security mode</name></smbconfoption></para></listitem>
			<listitem><para><smbconfoption><name>directory security mask</name></smbconfoption></para></listitem>
			<listitem><para><smbconfoption><name>force directory security mode</name></smbconfoption></para></listitem>
	</itemizedlist>

		</para>

		<para>Once a user clicks <guibutton>OK</guibutton> to apply the 
		permissions Samba maps the given permissions into a user/group/world 
		r/w/x triplet set, and then will check the changed permissions for a 
		file against the bits set in the  
		<smbconfoption><name>security mask</name></smbconfoption> parameter. Any bits that 
		were changed that are not set to '1' in this parameter are left alone 
		in the file permissions.</para>

		<para>Essentially, zero bits in the <smbconfoption><name>security mask</name></smbconfoption>
		mask may be treated as a set of bits the user is <emphasis>not</emphasis> 
		allowed to change, and one bits are those the user is allowed to change.
		</para>

		<para>If not set explicitly this parameter is set to the same value as 
			the <smbconfoption><name>create mask</name></smbconfoption>	parameter. To allow a user to modify all the
		user/group/world permissions on a file, set this parameter 
		to 0777.</para>

		<para>Next Samba checks the changed permissions for a file against 
		the bits set in the 
		<smbconfoption><name>force security mode</name></smbconfoption> parameter. Any bits 
		that were changed that correspond to bits set to '1' in this parameter 
		are forced to be set.</para>

		<para>Essentially, bits set in the <parameter>force security mode
		</parameter> parameter may be treated as a set of bits that, when 
		modifying security on a file, the user has always set to be 'on'.</para>

		<para>If not set explicitly this parameter is set to the same value 
			as the <smbconfoption><name>force create mode</name></smbconfoption> parameter.
		To allow a user to modify all the user/group/world permissions on a file
		with no restrictions set this parameter to 000.</para>

		<para>The <smbconfoption><name>security mask</name></smbconfoption> and <parameter>force 
		security mode</parameter> parameters are applied to the change 
		request in that order.</para>

		<para>For a directory Samba will perform the same operations as 
		described above for a file except using the parameter <parameter>
		directory security mask</parameter> instead of <parameter>security 
		mask</parameter>, and <parameter>force directory security mode
		</parameter> parameter instead of <parameter>force security mode
		</parameter>.</para>

		<para>The <smbconfoption><name>directory security mask</name></smbconfoption> parameter 
		by default is set to the same value as the <parameter>directory mask
		</parameter> parameter and the <parameter>force directory security 
		mode</parameter> parameter by default is set to the same value as 
		the <smbconfoption><name>force directory mode</name></smbconfoption> parameter. </para>

		<para>In this way Samba enforces the permission restrictions that 
		an administrator can set on a Samba share, whilst still allowing users 
		to modify the permission bits within that restriction.</para>

		<para>If you want to set up a share that allows users full control
		in modifying the permission bits on their files and directories and
		doesn't force any particular bits to be set 'on', then set the following
		parameters in the &smb.conf; file in that share specific section :
		</para>

		<smbconfblock>
			<smbconfoption><name>security mask</name><value>0777</value></smbconfoption>
			<smbconfoption><name>force security mode</name><value>0</value></smbconfoption>
			<smbconfoption><name>directory security mask</name><value>0777</value></smbconfoption>
			<smbconfoption><name>force directory security mode</name><value>0</value></smbconfoption>
		</smbconfblock>
	</sect2>

	<sect2>
		<title>Interaction with the standard Samba file attribute mapping</title>

		<note>
		<para>Samba maps some of the DOS attribute bits (such as "read 
		only") into the UNIX permissions of a file. This means there can 
		be a conflict between the permission bits set via the security 
		dialog and the permission bits set by the file attribute mapping.
		</para>
		</note>

		<para>One way this can show up is if a file has no UNIX read access
		for the owner it will show up as "read only" in the standard 
		file attributes tabbed dialog. Unfortunately this dialog is
		the same one that contains the security info in another tab.</para>

		<para>What this can mean is that if the owner changes the permissions
		to allow themselves read access using the security dialog, clicks
		<guibutton>OK</guibutton> to get back to the standard attributes tab 
		dialog, and then clicks <guibutton>OK</guibutton> on that dialog, then 
		NT will set the file permissions back to read-only (as that is what 
		the attributes still say in the dialog). This means that after setting 
		permissions and clicking <guibutton>OK</guibutton> to get back to the 
		attributes dialog you should always hit <guibutton>Cancel</guibutton> 
		rather than <guibutton>OK</guibutton> to ensure that your changes 
		are not overridden.</para>
	</sect2>
</sect1>

<sect1>
<title>Common Errors</title>

<para>
File, Directory and Share access problems are very common on the mailing list. The following
are examples taken from the mailing list in recent times.
</para>


	<sect2>
	<title>Users can not write to a public share</title>

	<para>
	<quote>
	We are facing some troubles with file / directory permissions. I can log on the domain as admin user(root),
	and there's a public share, on which everyone needs to have permission to create / modify files, but only
	root can change the file, no one else can. We need to constantly go to server to
	<userinput>chgrp -R users *</userinput> and <userinput>chown -R nobody *</userinput> to allow others users to change the file.
	</quote>
	</para>

	<para>
	There are many ways to solve this problem, here are a few hints:
	</para>

	<procedure>
		<step>
			<para>
			Go to the top of the directory that is shared
			</para>
		</step>

		<step>
			<para>
			Set the ownership to what ever public owner and group you want
<screen>
&prompt;find 'directory_name' -type d -exec chown user.group {}\;
&prompt;find 'directory_name' -type d -exec chmod 6775 'directory_name'
&prompt;find 'directory_name' -type f -exec chmod 0775 {} \;
&prompt;find 'directory_name' -type f -exec chown user.group {}\;
</screen>
			</para>

			<note><para>
			The above will set the 'sticky bit' on all directories. Read your
			UNIX/Linux man page on what that does. It causes the OS to assign 
			to all files created in the directories the ownership of the 
			directory.
			</para></note>
		</step>
		<step>
			<para>

			Directory is: <replaceable>/foodbar</replaceable>
<screen>
&prompt;<userinput>chown jack.engr /foodbar</userinput>
</screen>
			</para>

			<note>
				<para>This is the same as doing:</para>
<screen>
&prompt;<userinput>chown jack /foodbar</userinput>
&prompt;<userinput>chgrp engr /foodbar</userinput>
</screen>
			</note>
		</step>
		<step>
			<para>Now do: 

<screen>
&prompt;<userinput>chmod 6775 /foodbar</userinput>
&prompt;<userinput>ls -al /foodbar/..</userinput>
</screen>

			</para>
		
			<para>You should see:
<screen>
drwsrwsr-x  2 jack  engr    48 2003-02-04 09:55 foodbar
</screen>
			</para>
		</step>
		<step>

		<para>Now do:
<screen>
&prompt;<userinput>su - jill</userinput>
&prompt;<userinput>cd /foodbar</userinput>
&prompt;<userinput>touch Afile</userinput>
&prompt;<userinput>ls -al</userinput>
</screen>
		</para>

		<para>
		You should see that the file <filename>Afile</filename> created by Jill will have ownership
		and permissions of Jack, as follows:
<screen>
-rw-r--r--  1 jack  engr     0 2003-02-04 09:57 Afile
</screen>
		</para>
		</step>

		<step>
		<para>
		Now in your &smb.conf; for the share add:
		<smbconfblock>
<smbconfoption><name>force create mode</name><value>0775</value></smbconfoption>
<smbconfoption><name>force direcrtory mode</name><value>6775</value></smbconfoption>
		</smbconfblock>
		</para>

		<note><para>
		The above are only needed <emphasis>if</emphasis> your users are <emphasis>not</emphasis> members of the group
		you have used. ie: Within the OS do not have write permission on the directory.
		</para>
		</note>
		
		<para>
		An alternative is to set in the &smb.conf; entry for the share:
		<smbconfblock>
<smbconfoption><name>force user</name><value>jack</value></smbconfoption>
<smbconfoption><name>force group</name><value>engr</value></smbconfoption>
		</smbconfblock>
		</para>
	</step>
	</procedure>
	</sect2>


	<sect2>
		<title>I have set force user but Samba still makes <emphasis>root</emphasis> the owner of all the files I touch!</title>
		<para>
			When you have a user in <smbconfoption><name>admin users</name></smbconfoption>, samba will always do file operations for
			this user as <emphasis>root</emphasis>, even if <smbconfoption><name>force user</name></smbconfoption> has been set.
		</para>
	</sect2>
	
	<sect2>
		<title>MS Word with Samba changes owner of file</title>

		<para>
		<emphasis>Question:</emphasis> <quote>When userB saves a word document that is owned by userA the updated file is now owned by userB.
		Why is Samba doing this? How do I fix this?</quote>
		</para>

		<para>
		<emphasis>Answer:</emphasis> Word does the following when you modify/change a Word document: Word Creates a NEW document with
		a temporary name, Word then closes the old document and deletes it, Word then renames the new document to the original document name.
		There is NO mechanism by which Samba CAN IN ANY WAY know that the new document really should be owned by the owners
		of the original file. Samba has no way of knowing that the file will be renamed by MS Word.  As far as Samba is able
		to tell, the file that gets created is a NEW file, not one that the application (Word) is updating.
		</para>

		<para>
		There is a work-around to solve the permissions problem. That work-around involves understanding how you can manage file
		system behaviour from within the &smb.conf; file, as well as understanding how Unix file systems work. Set on the directory
		in which you are changing word documents: <command>chmod g+s 'directory_name'</command> This ensures that all files will
		be created with the group that owns the directory. In smb.conf share declaration section set:
		</para>

		<para>
		<smbconfblock>
                <smbconfoption><name>force create mode</name><value>0660</value></smbconfoption>
                <smbconfoption><name>force directory mode</name><value>0770</value></smbconfoption>
		</smbconfblock>
		</para>

		<para>
		These two settings will ensure that all directories and files that get created in the share will be read/writable by the
		owner and group set on the directory itself.
		</para>
		
	</sect2>

</sect1>

</chapter>
